<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminate and Stay Resident - DOS Interface</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="computer-wrapper">
            <!-- Inline SVG for interactivity -->
            <svg id="dos-computer" viewBox="0 0 282.33 289.03" xmlns="http://www.w3.org/2000/svg">
                <!-- Computer body -->
                <path style="stroke:#000000;stroke-width:1px;fill:#eeeeec"
                    d="m0.5 2.71s74.325-2.2106 140.79-2.2097c66.502 0.00094 140.54 2.2097 140.54 2.2097v232.08c-29.787 3.0387-57.976 8.7428-90.332 7.5h-50.332-49.975c-31.966 0.5394-62.526-1.3832-90.689-7.5v-116.04-116.04z"/>
                
                <!-- Monitor screen (dark) -->
                <rect id="monitor-screen" style="fill:#111" ry="5.1218" height="169.71" width="226.27" y="27.71" x="28.78"/>
                
                <!-- Screen off text -->
                <text id="screen-off-text" x="141" y="115" text-anchor="middle" fill="#333" font-family="VT323, monospace" font-size="12">
                    Press power button to boot
                </text>
                
                <!-- Power button area (bottom right circle) -->
                <g id="power-button-group" class="power-button" style="cursor: pointer;">
                    <circle id="power-button" cx="207.85" cy="225.23" r="6.69" style="stroke:#000000;stroke-width:1;fill:#444"/>
                    <text x="207.85" y="228" text-anchor="middle" fill="#888" font-family="sans-serif" font-size="8">‚èª</text>
                </g>
                
                <!-- Power LED (off by default, green when on) -->
                <rect id="power-led" style="fill:#222" ry=".53757" height="2.1466" width="2.3991" y="223.8" x="197.7"/>
                
                <!-- Other decorative elements -->
                <circle cx="161.49" cy="225.11" r="3.47" style="stroke:#000;fill:none"/>
                <circle cx="121.52" cy="225.11" r="3.47" style="stroke:#000;fill:none"/>
                <circle cx="136.13" cy="225.1" r="4.42" style="stroke:#000;fill:none"/>
                <circle cx="147.37" cy="225.1" r="4.42" style="stroke:#000;fill:none"/>
                
                <!-- Keyboard base -->
                <path style="stroke:#000;stroke-width:1px;fill:#eeeeec"
                    d="m91.22 242.36s5.0776 13.929 50.089 13.929c45.012 0 50.089-13.929 50.089-13.929v-0.0909l-100.18 0.0909z"/>
                
                <!-- Keyboard -->
                <g id="keyboard">
                    <path style="stroke:#000;stroke-width:1px;fill:none" d="m63 269.6s4.4902 11.071 77.857 11.071 77.857-11.071 77.857-11.071"/>
                    <path style="stroke:#000;stroke-width:1px;fill:none" d="m63 277.45s4.4902 11.071 77.857 11.071 77.857-11.071 77.857-11.071"/>
                    <path style="stroke:#000;stroke-width:1px;fill:none" d="m63.18 277.63v-7.6786"/>
                    <path style="stroke:#000;stroke-width:1px;fill:none" d="m218.54 277.63v-7.6786"/>
                </g>
                
                <!-- Keyboard cables -->
                <path style="stroke:#000;stroke-width:1px;fill:none" d="m101.22 250.49c-14.017 4.0796-26.392 11.114-38.036 19.464"/>
                <path style="stroke:#000;stroke-width:1px;fill:none" d="m181.22 250.49c14.017 4.0796 26.392 11.114 38.036 19.464"/>
                
                <!-- Keyboard detail layers -->
                <path style="fill:#d3d7cf"
                    d="m117.53 287.4c-26.573-1.0738-46.595-4.5381-52.571-9.0964-1.1703-0.89261-1.1791-0.92185-1.1791-3.9219v-3.0226l1.3782 0.91207c4.2436 2.8082 16.42 5.6349 30.586 7.1002 22.996 2.3787 58.651 2.6136 84.286 0.55532 16.092-1.292 29.025-3.8517 35.217-6.9695l2.462-1.2398v2.9928 2.9927l-1.3393 0.87075c-7.2179 4.6928-25.844 7.7574-53.839 8.8586-10.55 0.41501-34.355 0.398-45-0.0322z"/>
                <path style="fill:#eeeeec"
                    d="m117.53 279.55c-23.089-0.93297-41.51-3.6906-49.568-7.4204-4.0899-1.893-4.1034-1.6952 0.32325-4.7272 9.8252-6.7296 18.532-11.212 28.532-14.689l4.6439-1.6145 2.3204 0.85113c5.5624 2.0403 13.82 3.6361 23.035 4.4513 5.9833 0.52935 22.945 0.52935 28.929 0 9.2328-0.81682 17.821-2.4746 23.099-4.4589l2.2518-0.84653 4.1102 1.4372c9.4652 3.3096 18.119 7.6831 27.608 13.953l4.9266 3.2553-0.81951 0.62987c-4.8103 3.6972-19.096 6.7892-38.429 8.3173-15.17 1.1991-42.901 1.5907-60.962 0.86082z"/>
                <path style="fill:#d3d7cf"
                    d="m116.99 287.21c-17.153-0.91447-26.607-1.8949-36.071-3.7409-7.4499-1.4531-13.629-3.5131-15.667-5.223-1.086-0.91127-1.1796-1.1682-1.3743-3.7728l-0.20892-2.795 2.4643 1.2438c1.3554 0.68412 3.8263 1.6694 5.491 2.1895 4.4263 1.3829 14.411 3.2961 20.723 3.9709 1.0804 0.11548 2.5268 0.27199 3.2143 0.3478 3.3176 0.3658 13.694 1.2242 14.464 1.1965 0.39286-0.0141 4.4313 0.15882 8.9744 0.38428 6.4155 0.31839 41.41 0.32216 45.49 0.005 0.29464-0.0229 3.4286-0.19954 6.9643-0.39252 9.4138-0.51378 20.141-1.6399 25.179-2.6431 0.49108-0.0978 1.7513-0.27104 2.8005-0.38497 4.544-0.49346 16.842-4.2219 16.842-5.106 0-0.13629 0.32143-0.27202 0.71429-0.30162 0.65454-0.0493 0.71428 0.16636 0.71428 2.5782 0 2.4658-0.062 2.6757-0.98214 3.3227-6.4383 4.5272-23.307 7.5587-50.089 9.0016-5.7754 0.31116-44.308 0.40393-49.643 0.11953z"/>
            </svg>
        </div>
        
        <!-- Terminal overlay (hidden until power on) - OUTSIDE wrapper for mobile -->
        <div class="terminal-overlay hidden" id="terminal">
            <div class="terminal-content" id="output"></div>
            <div class="input-line">
                <span class="prompt" id="prompt-text">C:\TSR&gt;</span>
                <input type="text" id="command-input" class="command-input" autocomplete="off" spellcheck="false">
                <span class="cursor"></span>
            </div>
        </div>
    </div>

    <!-- Audio player (hidden) -->
    <audio id="audio-player"></audio>

    <script src="terminal.js"></script>
    <script>
        const powerButton = document.getElementById('power-button-group');
        const powerLed = document.getElementById('power-led');
        const terminal = document.getElementById('terminal');
        const screenOffText = document.getElementById('screen-off-text');
        const monitorScreen = document.getElementById('monitor-screen');
        let isPoweredOn = false;
        
        // Global audio unlock flag
        window.audioUnlocked = false;
        
        powerButton.addEventListener('click', function(e) {
            e.stopPropagation();
            
            if (!isPoweredOn) {
                // Power on
                isPoweredOn = true;
                
                // Create audio context to enable audio
                window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                window.audioContext.resume();
                
                // Unlock the audio element
                const audioEl = document.getElementById('audio-player');
                
                // Create a short silent buffer and play it
                const buffer = window.audioContext.createBuffer(1, 1, 22050);
                const source = window.audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(window.audioContext.destination);
                source.start(0);
                
                // Also unlock the HTML audio element
                audioEl.volume = 0;
                audioEl.muted = true;
                const playPromise = audioEl.play();
                if (playPromise) {
                    playPromise.then(() => {
                        audioEl.pause();
                        audioEl.currentTime = 0;
                        audioEl.volume = 1;
                        audioEl.muted = false;
                        window.audioUnlocked = true;
                    }).catch(() => {
                        audioEl.volume = 1;
                        audioEl.muted = false;
                    });
                }
                
                // Turn on LED
                powerLed.style.fill = '#73d216';
                
                // Hide "press power" text
                screenOffText.style.display = 'none';
                
                // Change screen to black (ready for terminal)
                monitorScreen.style.fill = '#000';
                
                // Show terminal
                terminal.classList.remove('hidden');
                
                // Go fullscreen on mobile
                if (window.innerWidth <= 768) {
                    document.body.classList.add('mobile-fullscreen');
                }
                
                // Run boot sequence
                if (typeof runBootSequence === 'function') {
                    runBootSequence();
                }
                
                // Focus input
                document.getElementById('command-input').focus();
            } else {
                // Power off
                isPoweredOn = false;
                
                // Stop any audio
                const audioEl = document.getElementById('audio-player');
                audioEl.pause();
                audioEl.currentTime = 0;
                
                // Hide now playing bar
                const npDiv = document.querySelector('.now-playing');
                if (npDiv) npDiv.classList.remove('visible');
                
                // Turn off LED
                powerLed.style.fill = '#222';
                
                // Show "press power" text
                screenOffText.style.display = 'block';
                
                // Change screen back to off state
                monitorScreen.style.fill = '#111';
                
                // Hide terminal
                terminal.classList.add('hidden');
                
                // Exit fullscreen on mobile
                document.body.classList.remove('mobile-fullscreen');
                
                // Clear terminal output
                document.getElementById('output').innerHTML = '';
                
                // Reset boot state so it runs again on next power on
                if (typeof resetBootState === 'function') {
                    resetBootState();
                }
            }
        });
        
        // Click on terminal focuses input
        terminal.addEventListener('click', function() {
            document.getElementById('command-input').focus();
        });
        
        // Handle mobile keyboard - scroll input into view when focused
        const cmdInput = document.getElementById('command-input');
        cmdInput.addEventListener('focus', function() {
            if (window.innerWidth <= 768) {
                // Small delay to let keyboard open
                setTimeout(() => {
                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        });
        
        // Use visualViewport API if available for better keyboard handling
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                if (window.innerWidth <= 768) {
                    const inputLine = document.querySelector('.input-line');
                    if (inputLine) {
                        // Adjust input position based on visual viewport
                        const keyboardHeight = window.innerHeight - window.visualViewport.height;
                        inputLine.style.bottom = keyboardHeight + 'px';
                    }
                }
            });
        }
    </script>
</body>
</html>
